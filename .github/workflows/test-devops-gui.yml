name: Test DevOps GUI Installer

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test-devops-gui:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Homebrew, pipx, and gum
        run: |
          if ! command -v brew &>/dev/null; then
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          brew update
          brew install pipx
          pipx ensurepath
          brew install charmbracelet/tap/gum

      - name: Configure shell environment
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)"
          export PATH="$HOME/.local/bin:$PATH"
          echo "üîß PATH = $PATH"

          # Explicitly add brew cask path for GUI tools
          export PATH="/opt/homebrew/bin:$PATH"
          export PATH="/opt/homebrew/Caskroom:$PATH"
          echo "üîß Updated PATH = $PATH"

      - name: Run setup-devops-gui.sh with --all
        shell: bash
        run: |
          chmod +x setup-devops-gui.sh
          bash setup-devops-gui.sh --all

      - name: Check GUI Tools Installation Directories
        run: |
          # Add directories where brew cask installs apps
          GUI_TOOL_PATHS=(
            "/opt/homebrew/Caskroom/docker/latest/Docker.app/Contents/MacOS"
            "/opt/homebrew/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/bin"
            "/Applications/Visual Studio Code.app/Contents/Resources/app/bin"
            "/Applications/iTerm.app/Contents/MacOS"
            "/opt/homebrew/Caskroom/tailscale/latest/Tailscale.app/Contents/MacOS"
            "/opt/homebrew/Caskroom/ngrok/latest/ngrok"
          )
          
          # Add paths to the system PATH
          for dir in "${GUI_TOOL_PATHS[@]}"; do
            if [[ -d "$dir" ]]; then
              export PATH="$PATH:$dir"
            fi
          done

          # Check if tools are available
          GUI_CLI_TOOLS=(
            docker
            gcloud
            code
            iterm2
            tailscale
            ngrok
          )

          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ GUI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ CLI..."
          FAIL=0
          for tool in "${GUI_CLI_TOOLS[@]}"; do
            echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞: $tool"
            if ! command -v "$tool" &>/dev/null; then
              echo "‚ùå $tool –ù–ï –î–û–°–¢–£–ü–ï–ù"
              FAIL=1
            else
              echo "‚úÖ $tool –¥–æ—Å—Ç—É–ø–µ–Ω"
            fi
          done

          if [[ "$FAIL" -ne 0 ]]; then
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ GUI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç"
            exit 1
          fi

      - name: Success
        if: success()
        run: echo "üéâ –í—Å–µ GUI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã!"
