name: Test Full DevOps Installer (GUI + CLI + Configs)

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test-macos-full:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare brew, pipx, gum
        run: |
          brew update
          brew install pipx
          pipx ensurepath
          brew install charmbracelet/tap/gum

      - name: Set PATHs
        run: |
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.bash_profile
          eval "$(/opt/homebrew/bin/brew shellenv)"
          export PATH="$HOME/.local/bin:$PATH"
          which brew
          which pipx
          which gum

      - name: Make script executable and run full install
        run: |
          chmod +x setup-devops.sh
          ./setup-devops.sh --all

      - name: Verify installed CLI tools
        run: |
          TOOLS=(
            terraform terragrunt terraform-docs tfsec
            kubectl helm k9s kind
            aws az gcloud
            glab docker lazygit
            bat fzf htop ncdu tree
            python pipx pre-commit
          )

          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ CLI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤..."
          FAIL=0
          for tool in "${TOOLS[@]}"; do
            if ! command -v "$tool" &>/dev/null; then
              echo "‚ùå $tool –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
              FAIL=1
            else
              echo "‚úÖ $tool —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
          done

          if [[ $FAIL -ne 0 ]]; then
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ CLI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!"
            exit 1
          fi

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ GUI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        continue-on-error: true
        run: |
          GUI_CASKS=(
            docker
            google-cloud-sdk
            visual-studio-code
            iterm2
            tailscale
            ngrok
          )

          echo "üñ•Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ GUI —Ç—É–ª–∑–æ–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –≤ CI)..."
          for cask in "${GUI_CASKS[@]}"; do
            if brew list --cask "$cask" &>/dev/null; then
              echo "‚úÖ $cask —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            else
              echo "‚ö†Ô∏è $cask –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∏ —ç—Ç–æ –û–ö –≤ CI-—Å—Ä–µ–¥–µ)"
            fi
          done

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Oh My Zsh
        run: |
          echo "üß™ –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ ~/.zshrc –∏ —Ç–µ–º—ã Powerlevel10k..."
          if [[ -f ~/.zshrc ]]; then
            echo "‚úÖ ~/.zshrc –Ω–∞–π–¥–µ–Ω"
          else
            echo "‚ùå ~/.zshrc –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
            exit 1
          fi

          if grep -q "powerlevel10k/powerlevel10k" ~/.zshrc; then
            echo "‚úÖ –¢–µ–º–∞ Powerlevel10k –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
          else
            echo "‚ùå –¢–µ–º–∞ Powerlevel10k –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
            exit 1
          fi

          echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤ Oh My Zsh..."
          PLUGINS=(zsh-autosuggestions zsh-syntax-highlighting zsh-completions zsh-z)
          for p in "${PLUGINS[@]}"; do
            if [[ -d "$HOME/.oh-my-zsh/custom/plugins/$p" ]]; then
              echo "‚úÖ –ü–ª–∞–≥–∏–Ω $p —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            else
              echo "‚ùå –ü–ª–∞–≥–∏–Ω $p –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
              exit 1
            fi
          done

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Neovim –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ Lazy.nvim
        run: |
          echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ Neovim –∏ Lazy.nvim..."
          if ! command -v nvim &>/dev/null; then
            echo "‚ùå Neovim –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi

          if [[ -f ~/.config/nvim/init.lua ]]; then
            echo "‚úÖ init.lua –Ω–∞–π–¥–µ–Ω"
          else
            echo "‚ùå init.lua –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
            exit 1
          fi

          echo "‚ö°Ô∏è –ó–∞–ø—É—Å–∫–∞—é nvim +Lazy (headless)..."
          nvim --headless "+Lazy! sync" +qa

      - name: –£—Å–ø–µ—Ö!
        if: success()
        run: echo "üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DevOps-—Ç—É–ª–∑–æ–≤, Oh My Zsh –∏ Neovim –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!"
