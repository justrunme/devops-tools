#!/usr/bin/env bash
set -e

# ---------- Ğ¦Ğ²ĞµÑ‚Ğ° Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ----------
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
NC="\033[0m"
function info()    { echo -e "${YELLOW}[INFO]${NC} $1"; }
function success() { echo -e "${GREEN}[OK]${NC} $1"; }

# ---------- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° gum ----------
if ! command -v gum &>/dev/null; then
  info "Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ gum..."
  brew install charmbracelet/tap/gum
fi

# ---------- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° pipx ----------
if ! command -v pipx &>/dev/null; then
  info "Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ pipx..."
  brew install pipx
  pipx ensurepath
fi

# ---------- ĞœĞ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ Ñ‚ÑƒĞ»Ğ·Ğ¾Ğ² Ğ½Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ (CI-friendly only) ----------
INSTALL_COMMANDS=("git=brew install git"
  "zsh=brew install zsh"
  "fzf=brew install fzf"
  "jq=brew install jq"
  "bat=brew install bat"
  "tree=brew install tree"
  "kubectl=brew install kubectl"
  "helm=brew install helm"
  "k9s=brew install k9s"
  "terraform=brew install terraform"
  "awscli=pipx install awscli"
  "az=brew install azure-cli"
  "gh=brew install gh"
  "glab=brew install glab"
  "pipx=brew install pipx && pipx ensurepath"
  "ansible=pipx install ansible"
  "act=brew install act"
  "direnv=brew install direnv"
  "zoxide=brew install zoxide"
  "httpie=brew install httpie"
  "cheat=brew install cheat"
  "btop=brew install btop")

# ---------- ĞÑ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ----------
ALL=false
for arg in "$@"; do
  [[ "$arg" == "--all" ]] && ALL=true
  [[ "$arg" == "-a" ]] && ALL=true
done

# ---------- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚ÑƒĞ»Ğ·Ğ¾Ğ² ----------
TOOL_LIST=(
  "ğŸ› ï¸ [CORE] git"
  "ğŸ› ï¸ [CORE] zsh"
  "ğŸ› ï¸ [CORE] fzf"
  "ğŸ› ï¸ [CORE] jq"
  "ğŸ› ï¸ [CORE] bat"
  "ğŸ› ï¸ [CORE] tree"
  "â˜¸ï¸ [KUBERNETES] kubectl"
  "â˜¸ï¸ [KUBERNETES] helm"
  "â˜¸ï¸ [KUBERNETES] k9s"
  "ğŸ“¦ [INFRA] terraform"
  "â˜ï¸ [CLOUD] awscli"
  "â˜ï¸ [CLOUD] az"
  "â˜ï¸ [CLOUD] gh"
  "â˜ï¸ [CLOUD] glab"
  "âš™ï¸ [DEVTOOLS] pipx"
  "âš™ï¸ [DEVTOOLS] ansible"
  "âš¡ [EXTRAS] act"
  "ğŸ”§ [UTILITIES] direnv"
  "ğŸ”§ [UTILITIES] zoxide"
  "ğŸ”§ [UTILITIES] httpie"
  "ğŸ”§ [UTILITIES] cheat"
  "ğŸ”§ [UTILITIES] btop"
)

# ---------- Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² ----------
if $ALL; then
  CHOICES="${TOOL_LIST[@]}"
else
  CHOICES=$(gum choose --no-limit --height=40 --header="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ (CI-friendly):" <<< "${TOOL_LIST[*]}")
fi

# ---------- Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚ÑƒĞ»Ğ·Ğ¾Ğ² ----------
for item in $CHOICES; do
  TOOL=$(echo "$item" | awk '{print $3}')
  for cmd in "${INSTALL_COMMANDS[@]}"; do
    if [[ "$cmd" == "$TOOL"* ]]; then
      COMD=$(echo "$cmd" | cut -d '=' -f2-)
      gum spin --title "Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ $TOOL..." -- bash -c "$COMD"
      success "$TOOL ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
    fi
  done
done

# ---------- Ğ¤Ğ¸Ğ½Ğ°Ğ» ----------
echo -e "\n${GREEN}Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°! ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ» Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸: source ~/.zshrc${NC}"
