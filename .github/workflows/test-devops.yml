name: Test Universal DevOps Installer

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-devops:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash

    steps:
      # –®–∞–≥ –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Homebrew, pipx –∏ gum
      - name: Install Homebrew, pipx and gum
        run: |
          echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Homebrew..."
          if ! command -v brew &>/dev/null; then
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          brew update
          brew install pipx
          pipx ensurepath
          brew install charmbracelet/tap/gum

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ–±–æ–ª–æ—á–∫–∏
      - name: Configure shell environment
        run: |
          eval "$(/opt/homebrew/bin/brew shellenv)"
          export PATH="$HOME/.local/bin:$PATH"
          echo "üîß PATH = $PATH"
          # –ü—Ä–æ–≤–µ—Ä–∏–º –≤–µ—Ä—Å–∏—é pipx –∏ gum
          echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π..."
          pipx --version
          gum --version

      # –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ DevOps –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
      - name: Run setup-devops.sh with --all
        shell: bash
        run: |
          chmod +x setup-devops.sh
          echo "üîß –ó–∞–ø—É—Å–∫ setup-devops.sh —Å —Ñ–ª–∞–≥–æ–º --all..."
          bash setup-devops.sh --all --debug

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö CLI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
      - name: Verify CLI tools installed
        run: |
          CLI_TOOLS=(git zsh fzf jq bat tree kubectl helm k9s terraform aws az gh glab pipx ansible act direnv zoxide httpie cheat btop)
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö CLI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤..."
          FAIL=0
          for tool in "${CLI_TOOLS[@]}"; do
            if ! command -v "$tool" &>/dev/null; then
              echo "‚ùå $tool –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù"
              FAIL=1
            else
              echo "‚úÖ $tool —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
          done

          if [[ "$FAIL" -ne 0 ]]; then
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ CLI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            exit 1
          fi

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GUI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ CLI
      - name: Verify GUI tools via CLI
        run: |
          GUI_CLI_TOOLS=(docker gcloud code iterm2 tailscale ngrok)
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GUI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ CLI..."
          FAIL=0
          for tool in "${GUI_CLI_TOOLS[@]}"; do
            if ! command -v "$tool" &>/dev/null; then
              echo "‚ùå $tool –ù–ï –î–û–°–¢–£–ü–ï–ù"
              FAIL=1
            else
              echo "‚úÖ $tool –¥–æ—Å—Ç—É–ø–µ–Ω"
            fi
          done

          if [[ "$FAIL" -ne 0 ]]; then
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ GUI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç"
            exit 1
          fi

      # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
      - name: Success
        if: success()
        run: echo "üéâ –í—Å–µ DevOps-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (CLI + GUI) —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã!"
